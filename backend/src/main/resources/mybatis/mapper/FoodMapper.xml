<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="torte.mapper.FoodMapper">
  <!-- Foodテーブルから履歴検索 -->
  <select id="searchHistory" resultType="torte.dto.response.FoodSearchResponseDto">
    SELECT
      h.id                   AS id,
      h.name                 AS name,
      h.calories             AS calories,
      h.protein              AS protein,
      h.carbs                AS carbs,
      h.fat                  AS fat,
      h.salt                 AS salt
    FROM food_search_history h
    WHERE
      (
        h.name ILIKE CONCAT('%', #{q}, '%')
        OR h.keywords ILIKE CONCAT('%', #{q}, '%')
      )
      <if test="category != null and category != ''">
        AND h.category = #{category}
      </if>
    ORDER BY h.last_used_at DESC
    LIMIT 50
    OFFSET 0
  </select>

  <!-- Ingredientテーブルから食品検索 -->
  <select id="searchIngredients" resultType="torte.dto.response.FoodSearchResponseDto">
    SELECT
      i.id                   AS id,
      i.name                 AS name,
      i.calories             AS calories,
      i.protein              AS protein,
      i.carbs                AS carbs,
      i.fat                  AS fat,
      i.salt                 AS salt
    FROM ingredients i
    WHERE i.name ILIKE CONCAT('%', #{q}, '%')
    ORDER BY i.name ASC
    LIMIT 50
    OFFSET 0
  </select>

  <!-- Brandテーブルから食品検索 -->
  <select id="searchBrands" resultType="torte.dto.response.FoodSearchResponseDto">
    SELECT
      b.id                   AS id,
      b.name                 AS name,
      b.calories             AS calories,
      b.protein              AS protein,
      b.carbs                AS carbs,
      b.fat                  AS fat,
      b.salt                 AS salt
    FROM brands b
    WHERE b.name ILIKE CONCAT('%', #{q}, '%')
    ORDER BY b.name ASC
    LIMIT 50
    OFFSET 0
  </select>

  <!-- Recipeテーブルから食品検索 -->
  <select id="searchRecipes" resultType="torte.dto.response.FoodSearchResponseDto">
    SELECT
      r.id                   AS id,
      r.name                 AS name,
      r.calories             AS calories,
      r.protein              AS protein,
      r.carbs                AS carbs,
      r.fat                  AS fat,
      r.salt                 AS salt
    FROM recipes r
    WHERE r.name ILIKE CONCAT('%', #{q}, '%')
    ORDER BY r.name DESC
    LIMIT 50
    OFFSET 0
  </select>

</mapper>